---
title: 'PBFT 합의 알고리즘 탐구하기'
date: '2025-04-13'
category: 'blockchain'
tags: ['consensus']
thumbnail: '/contents/posts/blockchain/pbft-consensus-algorithm/preview.jpg'
description: ''
---

## PBFT 알고리즘 (Practical Byzantine Fault Tolerance)

**네트워크에 배신자 노드가 어느 정도 있다고 가정하고, 네트워크 내에서 이루어지는 합의에 대한 신뢰를 보장**

```txt showLineNumbers
N = 전체 노드 수, F = 배신자 수, N - F = 정직한 노드 수

N > 2F, N >= 2F + 1 (50퍼센트 내구성)
F도 메시지를 생성하기 때문에 N - 2F > F 를 만족해야함
즉, N > 3F 이므로 N >= 3F + 1

전체 노드 수 N >= 3F + 1 을 만족해야 함
장애노드가 1/3 이상이면((1/3) - 1 이어야함) 라이브니스 충족을 보장할 수 없음
```

- 합의 알고리즘이 네트워크에서 통용되기 위한 특성 : **Safety, Liveness**
  - Safety: 절대로 잘못된 결정을 내리면 안된다. (안정성)
  - Liveness: 언젠가는 무조건 결정을 내린다. (응답성, 활성)
  - Fault tolerance: 장애 허용, 비동기 네트워크에서 누가 고장인지 악의적인지 구분할 수 없는 상황이 있어도 올바르게 작동
- 일반적으로 Safety가 우선하도록 설계
- PBFT는 장애 노드를 허용하고, Safety를 충족하면서 Liveness의 손실을 최소화하는 구조 (Liveness를 희생하지 않으면 어떤 상황에서도 블록이 생성되어야함. → 트랜잭션 변조와 같은 치명적인 상황)

  - 비트코인의 경우 최장 길이 체인 선택 알고리즘으로 Safety 보완(블록체인에서 finality)
    —> 확률적 Safety임(반쪽)
  - PoW, PoS는 블록이 한번 인정되지 않음(확률), 일정 블록이 생성된 후 안정됨(확률 증가)
  - 초기 Eth 2.0은 확률적 Finality였으나, Casper FFG 도입 후 PBFT의 Finality구조를 PoS위에 얹음 (확률적 Finality → BFT 기반 결정적 Finality)
  - 즉 비트코인은 확률적 Finality, Eth2.0은 초기에는 확률적 finality, BFT형

- 비동기 네트워크에서 장애 노드를 허용할 때 Safety와 Liveness를 모두 만족하는 합의 알고리즘을 설계하는 것은 불가능하다는 것이 증명됨 —> FLP 불가능성

  —> 비동기 네트워크에서 노드에 문제 발생 시 응답시간이 긴건지 합의 과정에서 충돌이 난건지 알 수 없기 때문

  - 비동기식 네트워크 모델에서 FLP 불가능성은 termination(liveness), agreement(safety), fault tolerance의 3가지 속성을 모두 달성할 수 없다고 주장
  - FLP 불가능성 때문에 PBFT 알고리즘은 Liveness를 희생하고 Safety를 충족

- **조건부 Liveness**

  - 라이브니스가 충족할 수 있는 조건부 환경

    1. 네트워크는 완전 동기적

       —> 메시지는 ∆ 이하 시간 안에 반드시 도착함

    2. f개 이하만 비잔틴 노드
    3. 타임아웃( ∆ )보다 충분히 긴 대기 시간을 둔다

       —> 정직한 리더가 있을 때 그 리더가 합의 메시지를 보낼 충분한 시간이 있어야함

  - 위의 조건을 만족할 수 없을 시 라이브니스를 보장할 수 없음
    → FLP 불가능성 정리의 결과(모든 BFT계열 알고리즘이 갖는 특성) - 전체 노드가 3f + 1개일 때 악의 노드가 f개 + 1이라면 두가지 문제 발생 - 리더가 계속 악의적인 노드일 수 있음
    → View Change로 리더 교체 반복(새로운 합의 계속 실패) - 정직한 노드끼리 합의 기준인 2f + 1 개의 동일 메시지를 모을 수 없음(정족수 불충분)
    → Commit 조건 미충족 합의 실패(유착 상태, 합의 정지) - 네트워크 지연 또는 메시지 손실 - 정직한 메시지가 도착하지 못함(정족수 불충분)
    → Commit 조건 미충족 합의 실패(유착 상태, 합의 정지) >>>>>>>>> 라이브니스 붕괴

## PBFT 정리

- 리더 노드가 합의 시도
  - 정상 노드의 정족수 (2f + 1)을 채우지 못할 시 합의 불가능 —> 라이브니스 붕괴
  - 리더가 악의 노드일 시 View Change 리더 교체
    - 교체 되어도 악의 노드면 View Change 무한 루프 —> 라이브니스 붕괴
- 정상적으로 합의 되는 경우: 전체 노드 3f + 1, 악의 노드 f개 이하(f개 까지 보장), 네트워크 지연 없음
- **FLP 불가능성 정리**에 기반해 설계된 의도적인 구조
